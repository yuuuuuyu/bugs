---
title: å¦‚ä½•è°ƒèµ·å°ç¨‹åºçš„æ”¯ä»˜
date: 2024-09-13
tags: 
  - å°ç¨‹åº
  - å¾®ä¿¡æ”¯ä»˜
  - é…ç½®å°ç¨‹åºåå°
  - æ”¯ä»˜ç­¾åå¤±è´¥
---

# å¦‚ä½•è°ƒèµ·å°ç¨‹åºçš„æ”¯ä»˜

> âœ¨æ–‡ç« æ‘˜è¦ï¼ˆAIç”Ÿæˆï¼‰

<!-- DESC SEP -->
ä»‹ç»äº†å¦‚ä½•åœ¨å¾®ä¿¡å°ç¨‹åºä¸­å®ç°æ”¯ä»˜åŠŸèƒ½ã€‚é¦–å…ˆï¼Œéœ€å®Œæˆå°ç¨‹åºè´¦å·æ³¨å†Œã€è®¤è¯åŠæ¥å…¥å¾®ä¿¡æ”¯ä»˜ç­‰å‰æœŸå‡†å¤‡å·¥ä½œã€‚æ¥ç€ï¼Œé€šè¿‡JSAPIåˆ›å»ºæ”¯ä»˜è®¢å•ï¼Œå¹¶åœ¨å°ç¨‹åºå†…ä½¿ç”¨wx.requestPaymentå‘èµ·æ”¯ä»˜ã€‚æ”¯ä»˜æˆåŠŸåï¼Œå•†æˆ·å°†æ”¶åˆ°æ”¯ä»˜ç»“æœé€šçŸ¥ï¼Œè‹¥æœªæ”¶åˆ°é€šçŸ¥ï¼Œå¯ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜ç»“æœã€‚ç¤ºä¾‹ä»£ç å±•ç¤ºäº†å°ç¨‹åºç«¯å’ŒæœåŠ¡å™¨ç«¯çš„å…³é”®å®ç°ï¼ŒåŒ…æ‹¬è·å–ç”¨æˆ·OpenIDã€åˆ›å»ºè®¢å•åŠå¤„ç†æ”¯ä»˜é€šçŸ¥çš„è¿‡ç¨‹ã€‚æ­¤å¤–ï¼Œè¿˜ç‰¹åˆ«å¼ºè°ƒäº†æ”¯ä»˜ç­¾åçš„é‡è¦æ€§ï¼Œè‹¥ç­¾åç”Ÿæˆé”™è¯¯ä¼šå¯¼è‡´æ”¯ä»˜éªŒè¯å¤±è´¥ã€‚é€šè¿‡éµå¾ªæœ¬æ–‡æŒ‡å¯¼ï¼Œå¼€å‘è€…å¯ä»¥é¡ºåˆ©å®ç°å¾®ä¿¡å°ç¨‹åºå†…çš„æ”¯ä»˜åŠŸèƒ½ã€‚
<!-- DESC SEP -->

::: tip
  **å¾®ä¿¡å°ç¨‹åºæ”¯ä»˜ç›¸å…³API**
  1. [æ¥å…¥å‰å‡†å¤‡](https://pay.weixin.qq.com/docs/partner/products/partner-mini-program-payment/preparation.html)
  2. [å¼€å‘æŒ‡å¼•](https://pay.weixin.qq.com/docs/partner/products/partner-mini-program-payment/development.html)
:::

## å‰æœŸå‡†å¤‡å·¥ä½œ

1. å°ç¨‹åºè´¦å·æ³¨å†Œ
2. è´¦å·è®¤è¯
3. æ¥å…¥å¾®ä¿¡æ”¯ä»˜/ç»‘å®šå•†æˆ·å·
4. æœåŠ¡å™¨é…ç½®(https)
5. [ä¸‹è½½ç§é’¥merchantPrivateKey](https://pay.weixin.qq.com/docs/partner/development/interface-rules/privatekey-and-certificate.html)
6. [ä¸‹è½½å¹³å°è¯ä¹¦wechatpayCertificates](https://pay.weixin.qq.com/docs/partner/products/platform-certificate/get-and-decryption.html)
   
   [ä½¿ç”¨æ–¹å¼ä¸‰ä¸‹è½½å¹³å°è¯ä¹¦](https://github.com/wechatpay-apiv3/CertificateDownloader)
   ```bash
   zhiyong.yu@yuuuuuu ~ % java -jar /Users/zhiyong.yu/Downloads/CertificateDownloader-1.2.0-jar-with-dependencies.jar  --key='è¯ä¹¦è§£å¯†çš„å¯†é’¥<apiV3key>' --mchid='å•†æˆ·å·' --serialno='å•†æˆ·è¯ä¹¦åºåˆ—å·' --privatekey='å•†æˆ·ç§é’¥æ–‡ä»¶' --output='è¯ä¹¦ä¿å­˜è·¯å¾„'
   ```

## ä¸šåŠ¡æµç¨‹å›¾

![å°ç¨‹åºå‘èµ·æ”¯ä»˜](https://pay.wechatpay.cn/wiki/doc/apiv3/assets/img/pay/wechatpay/6_2.png)

## é‡ç‚¹æ­¥éª¤

1. æ­¥éª¤4ï¼šç”¨æˆ·ä¸‹å•å‘èµ·æ”¯ä»˜ï¼Œå•†æˆ·å¯é€šè¿‡[JSAPI](https://pay.weixin.qq.com/docs/partner/apis/partner-mini-program-payment/partner-mini-prepay.html)ä¸‹å•åˆ›å»ºæ”¯ä»˜è®¢å•ã€‚

2. æ­¥éª¤9ï¼šå•†æˆ·å°ç¨‹åºå†…ä½¿ç”¨[å°ç¨‹åºè°ƒèµ·æ”¯ä»˜API/wx.requestPayment](https://pay.weixin.qq.com/docs/partner/apis/partner-mini-program-payment/mini-transfer-payment.html)å‘èµ·å¾®ä¿¡æ”¯ä»˜ï¼Œè¯¦è§[å°ç¨‹åºAPIæ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html)

3. æ­¥éª¤16ï¼šç”¨æˆ·æ”¯ä»˜æˆåŠŸåï¼Œå•†æˆ·å¯æ¥æ”¶åˆ°å¾®ä¿¡æ”¯ä»˜æ”¯ä»˜ç»“æœé€šçŸ¥[æ”¯ä»˜é€šçŸ¥API/notify_url](https://pay.weixin.qq.com/docs/partner/apis/partner-mini-program-payment/payment-notice.html)ã€‚

4. æ­¥éª¤21ï¼šå•†æˆ·åœ¨æ²¡æœ‰æ¥æ”¶åˆ°å¾®ä¿¡æ”¯ä»˜ç»“æœé€šçŸ¥çš„æƒ…å†µä¸‹éœ€è¦ä¸»åŠ¨è°ƒç”¨[æŸ¥è¯¢è®¢å•API](https://pay.weixin.qq.com/docs/partner/apis/partner-mini-program-payment/query-by-wx-trade-no.html)æŸ¥è¯¢æ”¯ä»˜ç»“æœã€‚

## ä»£ç è¯¦è§£

### å°ç¨‹åºä»£ç 
```js
Page({
    // æ­¥éª¤1:è¿›å…¥å°ç¨‹åºä¸‹å•!!!!!
    requestPayment(e) {
        const product = e.currentTarget.dataset.product;
        const price = e.currentTarget.dataset.price;
        await wx.login({
            success: loginRes => {
                if (loginRes.code) {
                    wx.request({
                        url: `${app.globalData.url}/wechat/getOpenid`,
                        method: 'POST',
                        data: {
                            code: loginRes.code,
                        },
                        success: function(openidResponse) {
                            if (openidResponse.data.success) {
                                wx.request({
                                    // é€šè¿‡loginè¿”å›çš„codeè·å–openidï¼Œè°ƒç”¨åç«¯åˆ›å»ºè®¢å•æ¥å£
                                    // æ­¥éª¤2:è¯·æ±‚ä¸‹å•æ”¯ä»˜!!!!!!
                                    url: `${app.globalData.url}/wechat/createOrder`, 
                                    method: 'POST',
                                    data: {
                                        openid: openidResponse.data.openid, // ç”¨æˆ·çš„openid
                                        total_fee: price*100, // æ”¯ä»˜é‡‘é¢ï¼Œå•ä½ä¸ºåˆ†
                                        description: product
                                    },
                                    header: {
                                        // è¯·æ±‚å¤´
                                    },
                                    success: function(orderResponse) {
                                        // æ­¥éª¤8:æ¥å£è¿”å›æ”¯ä»˜å‚æ•°!!!!!
                                        const paymentParams = orderResponse.data;
                                        if (!paymentParams || !paymentParams.timeStamp || !paymentParams.nonceStr || !paymentParams.packageVal || !paymentParams.paySign) {
                                            console.error('Invalid payment parameters');
                                            return;
                                        }
                                        // æ­¥éª¤9:è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API!!!!!!
                                        // æ­¥éª¤10:é‰´æƒå¹¶è°ƒèµ·æ”¯ä»˜ï¼Œå¦‚æœpaySignæœ‰é—®é¢˜ä¼šæŠ¥é”™â€˜å¹³å°ç­¾åå¤±è´¥â€™
                                        wx.requestPayment({
                                            timeStamp: paymentParams.timeStamp,
                                            nonceStr: paymentParams.nonceStr,
                                            package: paymentParams.packageVal,
                                            signType: 'RSA',
                                            paySign: paymentParams.paySign,
                                            success(res) {
                                                console.log('Payment success:', res);
                                            },
                                            fail(err) {
                                                console.error('Payment fail:', err);
                                            }
                                        });
                                    },
                                    fail: function(err) {
                                        console.error('Create order request failed:', err);
                                    }
                                });
                            }
                        },
                        fail: function(err) {
                            console.error('Get OpenID request failed:', err);
                            wx.showToast({
                                title: 'è·å–OpenIDå¤±è´¥',
                                icon: 'none'
                            });
                        }
                    });
                } else {
                    wx.showToast({
                        title: 'è¯·æ±‚å¤±è´¥',
                        icon: 'none'
                    });
                }
            },
            fail: function(err) {
                wx.showToast({
                    title: 'ç™»å½•å¤±è´¥',
                    icon: 'none'
                });
            }
        });
    }
})
```
### æœåŠ¡ç«¯ä»£ç node
æ¥å£1: **getOpenid**
```js
// è·å–openid
app.post('/wechat/getOpenid', (req, res) => {
    const jsCode = req.body.code;
    const url = `https://api.weixin.qq.com/sns/jscode2session?appid=${appID}&secret=${appSecret}&js_code=${jsCode}&grant_type=authorization_code`;
    request(url, (error, response, body) => {
        if (!error && response.statusCode === 200) {
            const data = JSON.parse(body);
            if (data.openid) {
                res.send({ openid: data.openid, success: 'success' });
            } else {
                res.status(500).send({ success: false, message: 'Failed to get openId' });
            }
        } else {
            res.status(500).send({ success: false, message: 'Error getting openId' });
        }
    });
});
```
æ¥å£2:**createOrder**
```js
// æ­¥éª¤2:å°ç¨‹åºè¯·æ±‚ä¸‹å•æ”¯ä»˜
app.post('/wechat/createOrder', async (req, res) => {
    const { openid, total_fee } = req.body;
    try {
        const out_trade_no = `YFRISK_${Date.now()}`
        // æ­¥éª¤3:ç”Ÿæˆå¹³å°è®¢å•
        const result = await createOrder(openid, out_trade_no, total_fee);

        if (result.prepay_id) {
            // æ­¥éª¤7:ç”Ÿæˆå¸¦ç­¾åçš„æ”¯ä»˜ä¿¡æ¯
            const paymentParams = generatePayParams(result.prepay_id);
            // æ­¥éª¤8:è¿”å›æ”¯ä»˜å‚æ•°
            res.send(paymentParams);
        } else {
            console.error('Error getting prepay_id:', result);
            res.status(500).send({ error: result.message });
        }
    } catch (error) {
        console.error('Error creating order:', error);
        res.status(500).send({ error: 'Internal server error' });
    }
});
// SHA256ç”Ÿæˆç­¾å
function generateSignature(data) {
    const sign = crypto.createSign('SHA256');
    sign.update(data);
    sign.end();
    return sign.sign(privateKey, 'base64');
}

async function createOrder(openid, out_trade_no, total_fee) {
    const method = 'POST';
    const urlPath = '/v3/pay/transactions/jsapi';
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const nonceStr = crypto.randomBytes(16).toString('hex');
    const body = JSON.stringify({
        appid: appID,
        mchid: mchId,
        description: 'Test Product',
        out_trade_no: out_trade_no,
        notify_url: 'https://aba3-2408-8417-28e0-bab8-a97c-2b47-584c-6570.ngrok-free.app/notify',
        amount: {
            total: total_fee,
            currency: 'CNY'
        },
        payer: {
            openid: openid
        }
    });

    const dataToSign = `${method}\n${urlPath}\n${timestamp}\n${nonceStr}\n${body}\n`;
    const signature = generateSignature(dataToSign);

    const options = {
        url: 'https://api.mch.weixin.qq.com' + urlPath,
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3',
            'Authorization': `WECHATPAY2-SHA256-RSA2048 mchid="${mchId}",nonce_str="${nonceStr}",timestamp="${timestamp}",serial_no="${serialNo}",signature="${signature}"`
        },
        body: body
    };

    return new Promise((resolve, reject) => {
        // æ­¥éª¤4:è°ƒç”¨JSAPIæ¥å£ï¼Œåˆ›å»ºè®¢å•
        // æ­¥éª¤5:ç”Ÿæˆé¢„ä»˜å•
        request(options, (error, response, body) => {
            if (error) {
                reject(error);
            } else {
                // æ­¥éª¤6:è¿”å›é¢„ä»˜å•æ ‡è¯†
                resolve(JSON.parse(body));
            }
        });
    });
}

function generatePayParams(prepayId) {
    const timestamp = Math.floor(Date.now() / 1000).toString();
    const nonceStr = crypto.randomBytes(16).toString('hex');
    const pkg = `prepay_id=${prepayId}`;
    const signType = 'RSA';
    //  !!!!!!!é‡è¦ç­¾å,å¿…é¡»ä½¿ç”¨ä»¥ä¸‹å‚æ•°ç”Ÿæˆç­¾å
    // https://pay.weixin.qq.com/docs/partner/apis/partner-mini-program-payment/mini-transfer-payment.html
    const dataToSign = `${appID}\n${timestamp}\n${nonceStr}\n${pkg}\n`;
    const paySign = generateSignature(dataToSign);
    return {
        timeStamp: timestamp,
        nonceStr: nonceStr,
        packageVal: pkg,
        signType: signType,
        paySign: paySign
    };
}
```
æ¥å£3:**notify**
```js
// æ­¥éª¤16/17/18:
app.post('/notify', (req, res) => {
    const payload = JSON.stringify(req.body);
    const signature = req.headers['wechatpay-signature'];
    const timestamp = req.headers['wechatpay-timestamp'];
    const nonce = req.headers['wechatpay-nonce'];
    const verify = crypto.createVerify('SHA256');
    verify.update(`${timestamp}\n${nonce}\n${payload}\n`);
    const isVerified = verify.verify(wechatPublicKey, signature, 'base64');

    if (isVerified) {
        // ç­¾åéªŒè¯æˆåŠŸï¼Œå¤„ç†æ”¯ä»˜ç»“æœé€šçŸ¥
        const notification = JSON.parse(payload);
        console.log('Payment notification:', notification);

        // æ ¹æ®é€šçŸ¥å†…å®¹å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¾‹å¦‚æ›´æ–°è®¢å•çŠ¶æ€
        // ...

        // è¿”å›æˆåŠŸåº”ç­”
        res.status(200).send('success');
    } else {
        // ç­¾åéªŒè¯å¤±è´¥
        console.error('Signature verification failed');
        res.status(400).send('signature verification failed');
    }
});
```

## æŠ¥é”™ï¼šæ”¯ä»˜éªŒè¯ç­¾åå¤±è´¥
åœ¨`æ­¥éª¤7:ç”Ÿæˆå¸¦ç­¾åçš„æ”¯ä»˜ä¿¡æ¯`ä¸­å¦‚æœæ²¡æœ‰æ­£ç¡®è®¾ç½®å‚æ•°ç”Ÿæˆç­¾åå°±ä¼šæŠ¥é”™
![æ”¯ä»˜éªŒè¯ç­¾åå¤±è´¥](http://ebugs.l2.ttut.cc/drawing-bed/20240926/æ”¯ä»˜éªŒè¯ç­¾åå¤±è´¥.jpeg)

## æœåŠ¡ç«¯å®Œæ•´ä»£ç 
:::tip
å¯èƒ½ä¸æ˜¯æœ€å®Œæ•´ï¼Œä½†æ˜¯å®ç°äº†åŸºæœ¬çš„æ”¯ä»˜ğŸ¤£
:::
[wechatpay-node](https://github.com/yuuuuuyu/wechatpay-node)