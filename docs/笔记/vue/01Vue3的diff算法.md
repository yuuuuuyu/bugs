# Vue3的diff算法

:::tip
纯文字版

后续写个图文版
::: 
Vue3的diff算法主要基于两个核心概念：静态标记（PatchFlag）和动态数组（Dynamic Children）。

### **静态标记（PatchFlag）**
   - 在Vue 3中，编译器会为模板中的每个元素和组件添加一个PatchFlag。这个标记指示了元素或组件的哪些部分是动态的，例如文本、属性、类名等。
   - 源码中，PatchFlag是在`packages/compiler-core/src/ast.ts`中定义的枚举类型，用于标记元素的动态部分。
   - 例如，如果一个元素只有文本是动态的，那么它将有一个`TEXT`类型的PatchFlag。

### **动态数组（Dynamic Children）**
   - 在Vue 3中，只有带有PatchFlag的元素会被视为动态元素，并在diff过程中进行比较。
   - 源码中，`packages/runtime-core/src/renderer.ts`中的`patch`函数会检查元素是否有PatchFlag，如果有，则只对这些动态部分进行diff比较。
   - 这种方法减少了需要比较的元素数量，从而提高了性能。

### **双端比较（Two-end Diff）**
   - Vue 3的diff算法采用了双端比较的策略，即同时从新旧节点的两端开始比较，以快速找到需要移动或删除的节点。
   - 源码中，`packages/runtime-core/src/renderer.ts`中的`patchKeyedChildren`函数实现了这一逻辑。
   - 该函数首先尝试从两端匹配节点，然后使用一个while循环来处理中间部分的节点。

### **最长递增子序列（Longest Increasing Subsequence）**
   - 当需要移动节点时，Vue 3使用最长递增子序列算法来确定最少的移动次数。
   - 源码中，`packages/runtime-core/src/renderer.ts`中的`getSequence`函数实现了这一算法。
   - 这个算法帮助Vue 3在处理列表时，尽可能地减少DOM操作，提高性能。

### **优化策略**
   - Vue 3的diff算法还包括其他优化策略，如静态提升（Static Hoisting）和缓存内联事件处理函数等。
   - 静态提升是指在编译时将静态节点的创建提升到渲染函数之外，减少不必要的VNode创建和比较。
   - 缓存内联事件处理函数可以避免在每次渲染时重新创建函数，减少内存开销。

总结来说，Vue 3的diff算法通过静态标记和动态数组来优化虚拟DOM的比较过程，通过双端比较和最长递增子序列算法来提高节点比较和移动的效率，并通过其他优化策略来减少不必要的操作。这些改进使得Vue 3在处理大型应用时更加高效。



在Vue 3中，diff算法的执行过程是边比较差异边进行更新的。这意味着在比较新旧虚拟DOM树的过程中，一旦发现差异，就会立即应用这些差异到实际的DOM上，而不是等到整个diff过程完成后再统一更新。

这种边diff边更新的策略有几个优点：

1. **减少不必要的计算**：如果等到所有差异比较完成后再更新，可能会导致一些不必要的计算，因为有些DOM操作可能已经使得后续的比较变得不必要。

2. **提高响应性**：边diff边更新可以更快地将变化反映到视图上，提高应用的响应性。

3. **优化性能**：通过立即应用差异，可以减少内存中需要维护的虚拟DOM树的大小，从而优化性能。

在Vue 3的源码中，这个过程主要在`packages/runtime-core/src/renderer.ts`文件中的`patch`函数中实现。`patch`函数会遍历新的虚拟DOM树，并与旧的虚拟DOM树进行比较。每当发现一个节点需要更新时，它会调用相应的`patch`函数来更新该节点及其子节点。这个过程是递归的，从根节点开始，逐层向下比较，并在必要时更新DOM。

例如，当`patch`函数发现一个元素的文本内容发生变化时，它会立即更新该元素的文本内容，而不是等到所有元素的比较完成后再更新。这种即时更新确保了视图能够快速反映出数据的变化，同时也避免了不必要的DOM操作。

总结来说，Vue 3的diff算法是边比较差异边进行更新的，这种策略有助于提高性能和响应性。